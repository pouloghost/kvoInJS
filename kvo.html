<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>kvo</title>
	<meta name="description" content="">
	<meta name="author" content="i-zhangty">

	<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	<script>
	function Observer(obj,method){
		this.obj = obj;
		this.mtd = method;
	}
	function equalCompatibilize(cls){
		if(cls.prototype.hasOwnProperty('equals')){
			return;
		}
		cls.prototype.equals = function(val){
			return this.toString()==val.toString();
		}
	};
	Array.prototype.removeObject = function(obj){
		for(i in this){
			if(this[i]!=Array.prototype.removeObject && this[i].equals(obj)){
				this.splice(i,1);
				return;
			}
		}
	};
	var old = Object.getOwnPropertyDescriptor;
	console.log(old);
Object.getOwnPropertyDescriptor = function(obj,key){
	var obj =  old(obj,key);
	console.log(obj);
	return obj;
}
function kvoCompatibilize (obj,key){//add a observer array and setter for the key
	var observerPropertyName = key+'Observers';
	var oldSetterName = '_set'+key.replace(key[0],key[0].toUpperCase());
	if(obj.hasOwnProperty(observerPropertyName)){//have been kvo compatiblized
		// if(obj.hasOwnProperty(setterMethodName)){
		// 	if(obj.hasOwnProperty('_'+setterMethodName)){//user defined setter
		// 		return;
		// 	}else{

		// 	}
		// }
		return;
	}else{
		//init observer list
		obj[observerPropertyName] = new Array();
		var oldSetter = Object.getOwnPropertyDescriptor(obj,key)['set'];//old setter
		console.log('got old setter');
		// obj[setterMethodName]
		 Object.defineProperty(obj,key,{'set':function(val){
			if(oldSetter){
				console.log(oldSetter);
				obj[oldSetterName] = oldSetter;// store for rollback
				obj[oldSetterName](val);
			}else{
				obj[key] = val;
			}
			for (observer in obj[observerPropertyName]){
				observer.mtd.call(observer.obj,val);
			}
		}});
		 console.log('property defined');
	}
}

function kvoDecompatibilize(obj,key){
	var observerPropertyName = key+'Observers';
	var oldSetterName = '_set'+key.replace(key[0],key[0].toUpperCase());
	if(!obj.hasOwnProperty(observerPropertyName)){// not compatible
		return;
	}else{
		if(obj[observerPropertyName].length == 0){
			delete obj[observerPropertyName];
			if(obj[oldSetterName]){
				Object.defineProperty(obj,key,{'set':obj[oldSetterName]});
				delete obj[oldSetterName];
			}
		}
	}
}
function addObserverForKeyInObj(observer,mtd,key,obj){
	kvoCompatibilize(obj,key);
	console.log('compatible');
	obj[key+'Observers'].push(new Observer(observer,mtd));
}

function removeObserverForKeyInObj(observer,mtd,key,obj){
	obj[key+'Observers'].removeObject(new Observer(observer,mtd));
	kvoDecompatibilize(obj,key);
}

var a = {'a': 'ddsaf'};
var b = {'observe':function(val){
	console.log(val);
}};

addObserverForKeyInObj(b,b.observe,'a',a);
a.a = 'aaaaa';
console.log('set');
removeObserverForKeyInObj(b,b.observe,'a',a);
a.a = 'bbbbb';

</script>
</head>

<body>
</body>
</html>
http://blog.willcannings.com/2009/03/19/key-value-coding-with-javascript/
https://code.google.com/p/zchain/source/browse/trunk/event/observer-v0.1.js?spec=svn49&r=48
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor?redirectlocale=en-US&redirectslug=JavaScript%2FReference%2FGlobal_Objects%2FObject%2FgetOwnPropertyDescriptor
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty?redirectlocale=en-US&redirectslug=JavaScript%2FReference%2FGlobal_Objects%2FObject%2FdefineProperty#Modifying_a_property